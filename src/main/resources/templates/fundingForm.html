<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funding Form</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Optional: Bootstrap theme -->
    <link rel="stylesheet" href="https://bootswatch.com/4/cosmo/bootstrap.min.css">
</head>
<body>

<div class="container mt-5">
    <h1 class="mb-4 text-center">Funding Form - Product Link</h1>

    <form id="linkForm" class="mb-4">
        <div class="form-group">
            <label for="itemLink">Item Link:</label>
            <input type="text" class="form-control" id="itemLink" name="itemLink" required>
            <div class="mt-2">
                <button type="button" class="btn btn-primary" onclick="previewItem()">상품 등록</button>
                <button type="button" class="btn btn-secondary" onclick="clearPreview()">상품 삭제</button>
            </div>
        </div>
    </form>

    <hr>

    <h2 class="mb-3">Preview Item Information:</h2>
    <div id="previewItemInfo" class="mb-4">

    </div>
    <form th:action="@{/funding/saveToDatabase}" th:object="${fundingDetails}" method="post">
        <div>
            <label for="itemName">상품 이름:</label>
            <input type="text" th:field="*{itemName}" placeholder="상품 이름"/>
        </div>
        <div>
            <label for="goalAmount">목표 금액:</label>
            <input type="text" th:field="*{goalAmount}" placeholder="목표 금액"/>
        </div>
        <div>
            <label for="title">제목:</label>
            <input type="text" th:field="*{title}" placeholder="제목"/>
        </div>
        <div>
            <label for="content">본문:</label>
            <textarea th:field="*{content}" placeholder="본문"></textarea>
        </div>
        <div class="form-group">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="publicFlag" id="public" value="true" th:checked="*{publicFlag}">
                <label class="form-check-label" for="public">공개</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="publicFlag" id="private" value="false" th:checked="*{!publicFlag}">
                <label class="form-check-label" for="private">비공개</label>
            </div>
        </div>
        <div>
            <label for="endDate">마감일 설정:</label>
            <input type="date" th:field="*{endDate}"/>
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-success">펀딩 등록하기</button>
        </div>
    </form>
</div>

<!-- JavaScript to handle AJAX requests and update the preview section -->
<script th:inline="javascript">
    function previewItem() {
        var itemLink = $("#itemLink").val();
        if (itemLink) {
            // AJAX request to the server for preview product information
            $.ajax({
                type: "POST",
                url: "/funding/previewItem",
                data: {itemLink: itemLink},
                dataType: "json",
                success: function (data) {
                    // Show the preview product information
                    var previewSection = $("#previewItemInfo");
                    previewSection.html("<h3>Preview Item Information:</h3>" +
                        "<p>Item Link: " + data.itemLink + "</p>" +
                        "<p>Item Image: <img src='" + data.itemImage + "' alt='Item Image'></p>");

                    // 추가: 상품 정보를 캐시에 저장
                    $.post("/funding/saveToCache", {itemLink: itemLink});
                }
            });
        }
    }

    $(document).ready(function() {
        // '공개' 체크박스의 상태가 바뀔 때마다 '비공개' 체크박스의 체크를 해제
        $('#publicFlag').change(function() {
            $('#privateFlag').prop('checked', !this.checked);
        });

        // '비공개' 체크박스의 상태가 바뀔 때마다 '공개' 체크박스의 체크를 해제
        $('#privateFlag').change(function() {
            $('#publicFlag').prop('checked', !this.checked);
        });
    });

    function clearPreview() {
        // Clear the preview section
        $("#previewItemInfo").empty();
        // Reset form fields including product link
        // $("#title").val("");
        // $("#content").val("");
        // $("#goalAmount").val("");
        // Clear other fields if needed

        // Clear the product link
        $("#itemLink").val("");

        // 추가: 캐시에 저장된 상품 정보를 삭제
        $.post("/funding/clearCachedItem", {itemLink: $("#itemLink").val()});
    }
</script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</body>
</html>